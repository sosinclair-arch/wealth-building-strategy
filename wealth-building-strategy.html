<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wealth Building Strategy - 15 Year Projection</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #f1f5f9;
      min-height: 100vh;
      padding: 24px;
      line-height: 1.5;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 28px; margin-bottom: 8px; }
    .subtitle { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }

    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #334155;
    }
    .card h2 { font-size: 18px; margin-bottom: 16px; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .metric-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #334155;
    }
    .metric-card.highlight {
      background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
      border: none;
    }
    .metric-label { font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
    .metric-card.highlight .metric-label { color: #fef3c7; }
    .metric-value { font-size: 24px; font-weight: bold; }
    .metric-value.green { color: #10b981; }
    .metric-value.blue { color: #3b82f6; }
    .metric-value.purple { color: #a855f7; }
    .metric-sub { font-size: 11px; color: #64748b; margin-top: 4px; }
    .metric-card.highlight .metric-sub { color: #fef3c7; }

    .chart-container { position: relative; height: 400px; margin-bottom: 24px; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 8px; text-align: right; border-bottom: 1px solid #334155; }
    th { color: #94a3b8; font-weight: 500; }
    th:first-child, td:first-child { text-align: left; }
    tr.highlight-row { background: #334155; }
    .text-purple { color: #a855f7; }
    .text-pink { color: #ec4899; }
    .text-blue { color: #3b82f6; }
    .text-green { color: #10b981; }
    .text-amber { color: #f59e0b; }
    .text-slate { color: #94a3b8; }
    .font-bold { font-weight: 600; }
    .small { font-size: 11px; color: #64748b; display: block; }

    .priority-list { display: flex; flex-direction: column; gap: 12px; }
    .priority-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      border-radius: 8px;
      align-items: flex-start;
    }
    .priority-item.amber { background: rgba(245, 158, 11, 0.15); border: 1px solid #b45309; }
    .priority-item.purple { background: rgba(168, 85, 247, 0.15); border: 1px solid #7c3aed; }
    .priority-item.pink { background: rgba(236, 72, 153, 0.15); border: 1px solid #db2777; }
    .priority-item.blue { background: rgba(59, 130, 246, 0.15); border: 1px solid #2563eb; }
    .priority-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }
    .priority-num.amber { background: #f59e0b; }
    .priority-num.purple { background: #a855f7; }
    .priority-num.pink { background: #ec4899; }
    .priority-num.blue { background: #3b82f6; }
    .priority-content h3 { font-size: 15px; margin-bottom: 4px; }
    .priority-content p { font-size: 13px; color: #cbd5e1; }
    .priority-content .note { font-size: 11px; color: #64748b; margin-top: 4px; }
    .priority-content .check { font-size: 11px; color: #10b981; margin-top: 4px; }

    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }

    .info-box {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .info-box.green { background: rgba(16, 185, 129, 0.15); border: 1px solid #059669; }
    .info-box.amber { background: rgba(245, 158, 11, 0.15); border: 1px solid #b45309; }
    .info-box h3 { font-size: 14px; margin-bottom: 8px; }
    .info-box .row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; }
    .info-box .total { border-top: 1px solid; padding-top: 8px; margin-top: 8px; }
    .info-box.green .total { border-color: #059669; }
    .info-box.amber .total { border-color: #b45309; }

    .footer-summary {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
      border: 1px solid #ec4899;
      border-radius: 12px;
      padding: 24px;
      margin-top: 24px;
    }
    .footer-summary h2 { margin-bottom: 16px; }
    .summary-result {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 16px;
      border-radius: 8px;
      background: #334155;
      color: #cbd5e1;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .tab.active { background: #10b981; color: white; }
    .tab:hover:not(.active) { background: #475569; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .assumptions-note {
      font-size: 12px;
      color: #64748b;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #334155;
    }

    .controls-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #334155;
    }
    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .presets {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .preset-btn {
      padding: 6px 12px;
      border-radius: 20px;
      background: #334155;
      color: #cbd5e1;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    .preset-btn.active { background: #10b981; color: white; }
    .preset-btn:hover:not(.active) { background: #475569; }

    .sliders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
    }
    .slider-group label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .slider-group .label-text { color: #94a3b8; }
    .slider-group .label-value { font-weight: bold; font-size: 16px; }
    .slider-group .label-value.purple { color: #a855f7; }
    .slider-group .label-value.blue { color: #3b82f6; }
    .slider-group .label-value.green { color: #10b981; }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #334155;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
    }
    input[type="range"].purple::-webkit-slider-thumb { background: #a855f7; }
    input[type="range"].blue::-webkit-slider-thumb { background: #3b82f6; }
    input[type="range"].green::-webkit-slider-thumb { background: #10b981; }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí∞ Wealth Building Strategy</h1>
    <p class="subtitle">15-Year Projection ‚Ä¢ 42M San Francisco ‚Ä¢ Mega Backdoor Roth Priority ‚Ä¢ Adjustable Returns</p>

    <!-- Return Assumptions Controls -->
    <div class="controls-card">
      <div class="controls-header">
        <h2 style="font-size: 16px;">üìä Return Assumptions</h2>
        <div class="presets">
          <button class="preset-btn" onclick="applyPreset('conservative')">Conservative</button>
          <button class="preset-btn active" onclick="applyPreset('moderate')">Moderate</button>
          <button class="preset-btn" onclick="applyPreset('aggressive')">Aggressive</button>
          <button class="preset-btn" onclick="applyPreset('bear')">Bear Market</button>
          <button class="preset-btn" onclick="applyPreset('bull')">Bull Market</button>
        </div>
      </div>

      <div class="sliders-grid">
        <div class="slider-group">
          <label>
            <span class="label-text">401k / Roth Return</span>
            <span class="label-value purple" id="retirementValue">7%</span>
          </label>
          <input type="range" class="purple" id="retirementSlider" min="0" max="15" step="0.5" value="7" oninput="updateProjection()">
          <div class="slider-labels"><span>0%</span><span>7% avg</span><span>15%</span></div>
        </div>

        <div class="slider-group">
          <label>
            <span class="label-text">Taxable Brokerage Return</span>
            <span class="label-value blue" id="brokerageValue">6%</span>
          </label>
          <input type="range" class="blue" id="brokerageSlider" min="0" max="15" step="0.5" value="6" oninput="updateProjection()">
          <div class="slider-labels"><span>0%</span><span>6% avg</span><span>15%</span></div>
        </div>

        <div class="slider-group">
          <label>
            <span class="label-text">HSA Return</span>
            <span class="label-value green" id="hsaValue">7%</span>
          </label>
          <input type="range" class="green" id="hsaSlider" min="0" max="15" step="0.5" value="7" oninput="updateProjection()">
          <div class="slider-labels"><span>0%</span><span>7% avg</span><span>15%</span></div>
        </div>
      </div>

      <p style="font-size: 11px; color: #64748b; margin-top: 16px;">
        üí° Historical S&P 500 average: ~10% nominal, ~7% inflation-adjusted. Taxable accounts often lower due to tax drag on dividends/gains.
      </p>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid" id="metrics"></div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('projection')">üìà Projection</button>
      <button class="tab" onclick="showTab('strategy')">üéØ Strategy</button>
      <button class="tab" onclick="showTab('milestones')">üèÜ Milestones</button>
      <button class="tab" onclick="showTab('liquidity')">üíß Liquidity</button>
    </div>

    <!-- Projection Tab -->
    <div id="projection" class="tab-content active">
      <div class="card">
        <h2>üìä Net Worth Projection (Mega Backdoor Priority)</h2>
        <div class="chart-container">
          <canvas id="projectionChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h2>üìã Year-by-Year Breakdown</h2>
        <div style="overflow-x: auto;">
          <table id="projectionTable"></table>
        </div>
      </div>
    </div>

    <!-- Strategy Tab -->
    <div id="strategy" class="tab-content">
      <div class="card">
        <h2>üéØ Investment Priority Waterfall</h2>
        <p style="color: #94a3b8; margin-bottom: 16px;">This strategy maximizes tax-free growth by prioritizing Mega Backdoor Roth:</p>

        <div class="priority-list">
          <div class="priority-item amber">
            <div class="priority-num amber">1</div>
            <div class="priority-content">
              <h3 class="text-amber">Emergency Fund (6 months)</h3>
              <p>Build to ~$45K in HYSA before investing excess.</p>
              <div class="note">Current: $10K ‚Üí Target: $45K</div>
            </div>
          </div>

          <div class="priority-item purple">
            <div class="priority-num purple">2</div>
            <div class="priority-content">
              <h3 class="text-purple">Max Pre-Tax 401k + HSA</h3>
              <p>Max 401k (~$24K employee limit) + employer contributions (10.5%). Max HSA (~$4,680/yr).</p>
              <div class="note">Employer: 3% match + 7.5% profit sharing = 10.5%</div>
            </div>
          </div>

          <div class="priority-item pink">
            <div class="priority-num pink">3</div>
            <div class="priority-content">
              <h3 class="text-pink">Mega Backdoor Roth (MAX FIRST!)</h3>
              <p>After-tax 401k ‚Üí immediate Roth conversion. ~$26K/year space after employer contributions.</p>
              <div class="note">$70K limit - $24K your contrib - $20K employer = ~$26K Mega Backdoor space</div>
              <div class="check">‚úì Contributions can be withdrawn anytime tax/penalty-free</div>
            </div>
          </div>

          <div class="priority-item purple" style="opacity: 0.7;">
            <div class="priority-num purple">4</div>
            <div class="priority-content">
              <h3 style="color: #c4b5fd;">Backdoor Roth IRA ($7,000/yr)</h3>
              <p>ONLY open after Mega Backdoor is fully maxed each year.</p>
            </div>
          </div>

          <div class="priority-item blue">
            <div class="priority-num blue">5</div>
            <div class="priority-content">
              <h3 class="text-blue">Taxable Brokerage (Last Resort)</h3>
              <p>ONLY if cash remains after maxing Mega Backdoor + IRA.</p>
              <div class="note" id="brokerageNote"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Milestones Tab -->
    <div id="milestones" class="tab-content">
      <div class="card">
        <h2>üèÜ Wealth Milestones</h2>
        <div id="milestonesList"></div>
      </div>

      <div class="metrics-grid" id="snapshotCards"></div>
    </div>

    <!-- Liquidity Tab -->
    <div id="liquidity" class="tab-content">
      <div class="card">
        <h2>üíß Liquidity Analysis (Year 15)</h2>
        <p style="color: #94a3b8; margin-bottom: 16px;">Understanding what money you can access before retirement (59¬Ω) without penalties.</p>

        <div class="two-col" id="liquidityBoxes"></div>

        <div style="background: rgba(51, 65, 85, 0.5); padding: 16px; border-radius: 8px; margin-top: 16px;">
          <h3 class="text-pink" style="font-size: 14px; margin-bottom: 8px;">üöÄ Mega Backdoor = Best of Both Worlds</h3>
          <p style="font-size: 13px;" id="megaBackdoorInsight"></p>
        </div>
      </div>

      <div class="card">
        <h2>üìà Liquidity Over Time</h2>
        <div style="overflow-x: auto;">
          <table id="liquidityTable"></table>
        </div>
      </div>
    </div>

    <!-- Footer Summary -->
    <div class="footer-summary">
      <h2>üìã Mega Backdoor Strategy Summary</h2>
      <div class="two-col">
        <div>
          <h3 class="text-pink" style="font-size: 14px; margin-bottom: 8px;">2026-2027 (Build Foundation)</h3>
          <ul style="font-size: 13px; color: #cbd5e1; padding-left: 20px;">
            <li>Ramp 401k contributions toward max</li>
            <li>Max HSA annually</li>
            <li>Pay off auto loan (ends Oct 2027)</li>
            <li>Excess cash ‚Üí savings (NO IRA/taxable yet)</li>
          </ul>
        </div>
        <div>
          <h3 class="text-purple" style="font-size: 14px; margin-bottom: 8px;">2028+ (Max Tax-Advantaged)</h3>
          <ul style="font-size: 13px; color: #cbd5e1; padding-left: 20px;">
            <li>Max Pre-Tax 401k (~$24K/yr)</li>
            <li>Mega Backdoor Roth: MAX all space first</li>
            <li>Backdoor IRA: only if Mega Backdoor maxed</li>
            <li>Taxable: only if all above maxed</li>
          </ul>
        </div>
      </div>
      <div class="summary-result" id="summaryResult"></div>
    </div>

    <div class="assumptions-note">
      <strong>Assumptions:</strong> 7% annual return (retirement/Roth), 6% taxable brokerage, 4.5% HYSA, 4% annual salary growth, 2.5% expense inflation, 2.5% IRS limit growth.
      Employer: 50% match on first 6% (= 3%) + 7.5% profit sharing = 10.5% total employer contribution.
    </div>
  </div>

  <script>
    // ============ PROJECTION MODEL ============
    const currentAge = 42;
    const currentYear = 2026;
    const baseGrossIncome = 195000;
    const incomeGrowthRate = 0.04;
    const currentRetirement = 78809;
    const currentSavings = 10035;
    const currentHSA = 4369;
    const currentAutoLoan = -17926;
    const baseMonthlyExpenses = 7612 - 178.75;
    const hsaContributionMonthly = 390;
    const moneyMarketReturn = 0.045;

    // Adjustable returns (will be updated by sliders)
    let retirementReturn = 0.07;
    let brokerageReturnRate = 0.06;
    let hsaReturnRate = 0.07;

    // Chart reference for updates
    let projectionChart = null;

    function getEmployee401kLimit(year) {
      return Math.round(23500 * Math.pow(1.025, year - 2025));
    }

    function get401kTotalLimit(year) {
      return Math.round(70000 * Math.pow(1.025, year - 2025));
    }

    function generateProjection() {
      const projection = [];

      let retirement = currentRetirement;
      let megaBackdoorRoth = 0;
      let backdoorRothIRA = 0;
      let taxableBrokerage = 0;
      let hsa = currentHSA;
      let autoLoan = currentAutoLoan;
      let emergencyFund = currentSavings;
      let megaBackdoorContributions = 0;
      let backdoorRothContributions = 0;

      for (let year = currentYear; year <= currentYear + 15; year++) {
        const age = currentAge + (year - currentYear);
        const yearsOut = year - currentYear;

        const grossIncome = Math.round(baseGrossIncome * Math.pow(1 + incomeGrowthRate, yearsOut));
        const netIncome = Math.round(grossIncome * 0.70);
        const monthlyExpenses = Math.round(baseMonthlyExpenses * Math.pow(1.025, yearsOut));
        const annualExpenses = monthlyExpenses * 12;

        const employee401kLimit = getEmployee401kLimit(year);
        const total401kLimit = get401kTotalLimit(year);
        const profitSharing = Math.round(grossIncome * 0.075);

        if (autoLoan < 0 && year <= 2027) {
          autoLoan = Math.min(0, autoLoan + (520 * 12));
        } else {
          autoLoan = 0;
        }

        const carPaymentFreedUp = autoLoan === 0 && year > 2027 ? 520 * 12 : 0;
        let annualCashAvailable = netIncome - annualExpenses + carPaymentFreedUp;

        const emergencyTarget = monthlyExpenses * 6;

        let toEmergency = 0;
        let toHSA = 0;
        let to401k = 0;
        let toMegaBackdoor = 0;
        let toBackdoorRothIRA = 0;
        let toBrokerage = 0;

        // Priority 1: Emergency fund
        if (emergencyFund < emergencyTarget && annualCashAvailable > 0) {
          toEmergency = Math.min(annualCashAvailable, emergencyTarget - emergencyFund);
          annualCashAvailable -= toEmergency;
        }

        // Priority 2: Max HSA
        const hsaLimit = hsaContributionMonthly * 12;
        if (annualCashAvailable > 0) {
          toHSA = Math.min(hsaLimit, annualCashAvailable);
          annualCashAvailable -= toHSA;
        }

        // Priority 3: Max Pre-Tax 401k
        if (annualCashAvailable > 0) {
          to401k = Math.min(employee401kLimit, annualCashAvailable);
          annualCashAvailable -= to401k;
        }

        const is401kMaxed = to401k >= employee401kLimit;

        // Employer match
        const sixPercentOfSalary = grossIncome * 0.06;
        const employerMatchRate = to401k >= sixPercentOfSalary ? 0.03 : (to401k / grossIncome) * 0.5;
        const employerMatch = Math.round(grossIncome * employerMatchRate);
        const totalEmployerContrib = profitSharing + employerMatch;

        // Priority 4: Mega Backdoor Roth
        let megaBackdoorMaxed = false;
        if (is401kMaxed && annualCashAvailable > 0) {
          const megaBackdoorSpace = Math.max(0, total401kLimit - to401k - totalEmployerContrib);
          toMegaBackdoor = Math.min(megaBackdoorSpace, annualCashAvailable);
          megaBackdoorContributions += toMegaBackdoor;
          annualCashAvailable -= toMegaBackdoor;
          megaBackdoorMaxed = toMegaBackdoor >= megaBackdoorSpace;
        }

        // Priority 5: Backdoor Roth IRA
        if (megaBackdoorMaxed && annualCashAvailable > 0) {
          toBackdoorRothIRA = Math.min(7000, annualCashAvailable);
          backdoorRothContributions += toBackdoorRothIRA;
          annualCashAvailable -= toBackdoorRothIRA;
        }

        // Priority 6: Taxable brokerage
        const isIRAMaxed = toBackdoorRothIRA >= 7000;
        if (megaBackdoorMaxed && isIRAMaxed && annualCashAvailable > 0) {
          toBrokerage = annualCashAvailable;
          annualCashAvailable = 0;
        }

        // Leftover stays in emergency
        if (annualCashAvailable > 0) {
          toEmergency += annualCashAvailable;
        }

        // Apply growth using current slider values
        emergencyFund = (emergencyFund + toEmergency) * (1 + moneyMarketReturn);
        hsa = hsa * (1 + hsaReturnRate) + toHSA;
        retirement = retirement * (1 + retirementReturn) + to401k + totalEmployerContrib;
        megaBackdoorRoth = megaBackdoorRoth * (1 + retirementReturn) + toMegaBackdoor;
        backdoorRothIRA = backdoorRothIRA * (1 + retirementReturn) + toBackdoorRothIRA;
        taxableBrokerage = taxableBrokerage * (1 + brokerageReturnRate) + toBrokerage;

        const totalRoth = megaBackdoorRoth + backdoorRothIRA;
        const accessibleRothContributions = megaBackdoorContributions + backdoorRothContributions;
        const netWorth = retirement + totalRoth + taxableBrokerage + hsa + emergencyFund + autoLoan;

        projection.push({
          year, age, grossIncome, netIncome, monthlyExpenses,
          retirement: Math.round(retirement),
          megaBackdoorRoth: Math.round(megaBackdoorRoth),
          backdoorRothIRA: Math.round(backdoorRothIRA),
          totalRoth: Math.round(totalRoth),
          megaBackdoorContributions: Math.round(megaBackdoorContributions),
          megaBackdoorGains: Math.round(megaBackdoorRoth - megaBackdoorContributions),
          backdoorRothContributions: Math.round(backdoorRothContributions),
          accessibleRothContributions: Math.round(accessibleRothContributions),
          taxableBrokerage: Math.round(taxableBrokerage),
          hsa: Math.round(hsa),
          emergencyFund: Math.round(emergencyFund),
          netWorth: Math.round(netWorth),
          retirementContrib: Math.round(to401k),
          totalEmployerContrib: Math.round(totalEmployerContrib),
          megaBackdoorContrib: Math.round(toMegaBackdoor),
          backdoorRothContrib: Math.round(toBackdoorRothIRA),
          brokerageContrib: Math.round(toBrokerage),
          is401kMaxed, megaBackdoorMaxed,
          liquidAssets: Math.round(emergencyFund + taxableBrokerage + accessibleRothContributions),
          retirementLocked: Math.round(retirement + hsa + (totalRoth - accessibleRothContributions)),
        });
      }

      return projection;
    }

    let projection = generateProjection();
    let year5 = projection.find(p => p.year === currentYear + 5);
    let year10 = projection.find(p => p.year === currentYear + 10);
    let year15 = projection.find(p => p.year === currentYear + 15);

    // Presets
    const presets = {
      conservative: { retirement: 5, brokerage: 4, hsa: 5 },
      moderate: { retirement: 7, brokerage: 6, hsa: 7 },
      aggressive: { retirement: 9, brokerage: 8, hsa: 9 },
      bear: { retirement: 3, brokerage: 2, hsa: 3 },
      bull: { retirement: 11, brokerage: 10, hsa: 11 }
    };

    function applyPreset(name) {
      const preset = presets[name];
      document.getElementById('retirementSlider').value = preset.retirement;
      document.getElementById('brokerageSlider').value = preset.brokerage;
      document.getElementById('hsaSlider').value = preset.hsa;

      // Update active button
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[onclick="applyPreset('${name}')"]`).classList.add('active');

      updateProjection();
    }
    window.applyPreset = applyPreset;

    function updateProjection() {
      // Read slider values
      const retVal = parseFloat(document.getElementById('retirementSlider').value);
      const broVal = parseFloat(document.getElementById('brokerageSlider').value);
      const hsaVal = parseFloat(document.getElementById('hsaSlider').value);

      // Update display values
      document.getElementById('retirementValue').textContent = retVal + '%';
      document.getElementById('brokerageValue').textContent = broVal + '%';
      document.getElementById('hsaValue').textContent = hsaVal + '%';

      // Update global rates
      retirementReturn = retVal / 100;
      brokerageReturnRate = broVal / 100;
      hsaReturnRate = hsaVal / 100;

      // Regenerate projection
      projection = generateProjection();
      year5 = projection.find(p => p.year === currentYear + 5);
      year10 = projection.find(p => p.year === currentYear + 10);
      year15 = projection.find(p => p.year === currentYear + 15);

      // Update all UI elements
      renderMetrics();
      updateChart();
      renderProjectionTable();
      renderMilestones();
      renderLiquidity();
      renderSummary();

      // Clear preset selection if manually adjusted
      const currentPreset = Object.entries(presets).find(([name, p]) =>
        p.retirement === retVal && p.brokerage === broVal && p.hsa === hsaVal
      );
      if (!currentPreset) {
        document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      }
    }
    window.updateProjection = updateProjection;

    function formatCurrency(value) {
      return '$' + (value || 0).toLocaleString();
    }

    function formatShort(value) {
      if (value >= 1000000) return '$' + (value / 1000000).toFixed(1) + 'M';
      if (value >= 1000) return '$' + Math.round(value / 1000) + 'K';
      return '$' + value;
    }

    // ============ RENDER UI ============

    function renderMetrics() {
      document.getElementById('metrics').innerHTML = `
      <div class="metric-card">
        <div class="metric-label">Current Net Worth</div>
        <div class="metric-value green">${formatCurrency(79218)}</div>
        <div class="metric-sub">Age ${currentAge}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">5-Year Projection</div>
        <div class="metric-value blue">${formatCurrency(year5?.netWorth)}</div>
        <div class="metric-sub">Age ${year5?.age}</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">10-Year Projection</div>
        <div class="metric-value purple">${formatCurrency(year10?.netWorth)}</div>
        <div class="metric-sub">Age ${year10?.age}</div>
      </div>
      <div class="metric-card highlight">
        <div class="metric-label">15-Year Projection</div>
        <div class="metric-value">${formatCurrency(year15?.netWorth)}</div>
        <div class="metric-sub">Age ${year15?.age}</div>
      </div>
      `;
    }

    function createChart() {
      const ctx = document.getElementById('projectionChart').getContext('2d');
      projectionChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: projection.map(p => p.year),
        datasets: [
          {
            label: 'Pre-Tax 401k',
            data: projection.map(p => p.retirement),
            backgroundColor: 'rgba(139, 92, 246, 0.3)',
            borderColor: '#8b5cf6',
            fill: true,
            tension: 0.3
          },
          {
            label: 'Mega Backdoor Roth',
            data: projection.map(p => p.megaBackdoorRoth),
            backgroundColor: 'rgba(236, 72, 153, 0.3)',
            borderColor: '#ec4899',
            fill: true,
            tension: 0.3
          },
          {
            label: 'Backdoor Roth IRA',
            data: projection.map(p => p.backdoorRothIRA),
            backgroundColor: 'rgba(244, 114, 182, 0.3)',
            borderColor: '#f472b6',
            fill: true,
            tension: 0.3
          },
          {
            label: 'HSA',
            data: projection.map(p => p.hsa),
            backgroundColor: 'rgba(16, 185, 129, 0.3)',
            borderColor: '#10b981',
            fill: true,
            tension: 0.3
          },
          {
            label: 'Emergency Fund',
            data: projection.map(p => p.emergencyFund),
            backgroundColor: 'rgba(245, 158, 11, 0.3)',
            borderColor: '#f59e0b',
            fill: true,
            tension: 0.3
          },
          {
            label: 'Total Net Worth',
            data: projection.map(p => p.netWorth),
            borderColor: '#ffffff',
            borderWidth: 3,
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#94a3b8' } },
          tooltip: {
            callbacks: {
              label: ctx => ctx.dataset.label + ': ' + formatCurrency(ctx.raw)
            }
          }
        },
        scales: {
          x: { ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
          y: {
            ticks: { color: '#94a3b8', callback: v => formatShort(v) },
            grid: { color: '#334155' }
          }
        }
      }
      });
    }

    function updateChart() {
      if (!projectionChart) return;

      projectionChart.data.labels = projection.map(p => p.year);
      projectionChart.data.datasets[0].data = projection.map(p => p.retirement);
      projectionChart.data.datasets[1].data = projection.map(p => p.megaBackdoorRoth);
      projectionChart.data.datasets[2].data = projection.map(p => p.backdoorRothIRA);
      projectionChart.data.datasets[3].data = projection.map(p => p.hsa);
      projectionChart.data.datasets[4].data = projection.map(p => p.emergencyFund);
      projectionChart.data.datasets[5].data = projection.map(p => p.netWorth);
      projectionChart.update();
    }

    function renderProjectionTable() {
      let tableHTML = `
      <thead>
        <tr>
          <th>Year</th>
          <th class="text-amber">E-Fund</th>
          <th class="text-purple">401k</th>
          <th class="text-pink">Mega BD</th>
          <th class="text-pink" style="opacity:0.7">IRA</th>
          <th class="text-blue">Taxable</th>
          <th>Status</th>
          <th class="text-green font-bold">Net Worth</th>
        </tr>
      </thead>
      <tbody>
    `;

    projection.forEach(p => {
      const isHighlight = [2031, 2036, 2041].includes(p.year);
      let status = '<span class="text-amber">‚Üí401k</span>';
      if (p.is401kMaxed && p.megaBackdoorMaxed) status = '<span class="text-green">All Maxed</span>';
      else if (p.is401kMaxed) status = '<span class="text-pink">401k‚úì MB‚Üí</span>';

      tableHTML += `
        <tr class="${isHighlight ? 'highlight-row' : ''}">
          <td class="font-bold">${p.year}</td>
          <td class="text-amber">${formatShort(p.emergencyFund)}</td>
          <td class="text-purple">${formatShort(p.retirement)}<span class="small">+${formatShort(p.retirementContrib)}</span></td>
          <td class="text-pink">${formatShort(p.megaBackdoorRoth)}${p.megaBackdoorContrib > 0 ? '<span class="small">+' + formatShort(p.megaBackdoorContrib) + '</span>' : ''}</td>
          <td class="text-pink" style="opacity:0.7">${formatShort(p.backdoorRothIRA)}${p.backdoorRothContrib > 0 ? '<span class="small">+' + formatShort(p.backdoorRothContrib) + '</span>' : ''}</td>
          <td class="text-blue">${formatShort(p.taxableBrokerage)}${p.brokerageContrib > 0 ? '<span class="small">+' + formatShort(p.brokerageContrib) + '</span>' : ''}</td>
          <td>${status}</td>
          <td class="text-green font-bold">${formatShort(p.netWorth)}</td>
        </tr>
      `;
    });
      tableHTML += '</tbody>';
      document.getElementById('projectionTable').innerHTML = tableHTML;
    }

    function renderBrokerageNote() {
        const brokerageStart = projection.find(p => p.brokerageContrib > 0);
      document.getElementById('brokerageNote').textContent = brokerageStart
        ? `Projected to start: ${brokerageStart.year}`
        : 'Not projected to be needed within 15 years';
    }

    function renderMilestones() {
      // Milestones
    const milestones = [
      { amount: 100000, label: '$100K Net Worth', icon: 'üéØ' },
      { amount: 250000, label: '$250K Net Worth', icon: '‚≠ê' },
      { amount: 500000, label: '$500K Net Worth', icon: 'üåü' },
      { amount: 750000, label: '$750K Net Worth', icon: 'üí´' },
      { amount: 1000000, label: '$1M Net Worth', icon: 'üèÜ' },
      { amount: 1500000, label: '$1.5M Net Worth', icon: 'üëë' },
      { amount: 2000000, label: '$2M Net Worth', icon: 'üíé' },
    ];

    let milestonesHTML = '';
    milestones.forEach(m => {
      const achieved = projection.find(p => p.netWorth >= m.amount);
      const style = achieved
        ? (achieved.year <= currentYear ? 'background: rgba(16,185,129,0.15); border: 1px solid #059669;' : 'background: #334155; border: 1px solid #475569;')
        : 'opacity: 0.5;';

      milestonesHTML += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 8px; margin-bottom: 8px; ${style}">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 24px;">${m.icon}</span>
            <div>
              <div style="font-weight: 600;">${m.label}</div>
              <div style="font-size: 12px; color: #94a3b8;">
                ${achieved ? (achieved.year <= currentYear ? 'Achieved!' : `Projected: ${achieved.year} (Age ${achieved.age})`) : 'Beyond 15-year projection'}
              </div>
            </div>
          </div>
          ${achieved ? `<div style="background: ${achieved.year <= currentYear ? '#10b981' : '#475569'}; padding: 4px 12px; border-radius: 20px; font-size: 12px;">${achieved.year <= currentYear ? '‚úì Done' : (achieved.year - currentYear) + ' years'}</div>` : ''}
        </div>
      `;
    });
      document.getElementById('milestonesList').innerHTML = milestonesHTML;

      // Snapshot cards
    document.getElementById('snapshotCards').innerHTML = `
      <div class="metric-card" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); border: none;">
        <div class="metric-label" style="color: #bfdbfe;">5-Year Snapshot</div>
        <div class="metric-value">${formatCurrency(year5?.netWorth)}</div>
        <div class="metric-sub" style="color: #bfdbfe;">Age: ${year5?.age} ‚Ä¢ Mega BD: ${formatCurrency(year5?.megaBackdoorRoth)}</div>
      </div>
      <div class="metric-card" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); border: none;">
        <div class="metric-label" style="color: #ddd6fe;">10-Year Snapshot</div>
        <div class="metric-value">${formatCurrency(year10?.netWorth)}</div>
        <div class="metric-sub" style="color: #ddd6fe;">Age: ${year10?.age} ‚Ä¢ Mega BD: ${formatCurrency(year10?.megaBackdoorRoth)}</div>
      </div>
      <div class="metric-card" style="background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); border: none;">
        <div class="metric-label" style="color: #fef3c7;">15-Year Snapshot</div>
        <div class="metric-value">${formatCurrency(year15?.netWorth)}</div>
        <div class="metric-sub" style="color: #fef3c7;">Age: ${year15?.age} ‚Ä¢ Mega BD: ${formatCurrency(year15?.megaBackdoorRoth)}</div>
      </div>
      `;
    }

    function renderLiquidity() {
      // Liquidity boxes
    const rothGains = year15?.megaBackdoorGains + (year15?.backdoorRothIRA - year15?.backdoorRothContributions);
    document.getElementById('liquidityBoxes').innerHTML = `
      <div class="info-box green">
        <h3 class="text-green">‚úÖ Accessible Anytime</h3>
        <div class="row"><span>Emergency Fund</span><span class="text-green font-bold">${formatCurrency(year15?.emergencyFund)}</span></div>
        <div class="row"><span>Taxable Brokerage</span><span class="text-green font-bold">${formatCurrency(year15?.taxableBrokerage)}</span></div>
        <div class="row"><span>Roth Contributions*</span><span class="text-green font-bold">${formatCurrency(year15?.accessibleRothContributions)}</span></div>
        <div class="row total"><span class="font-bold">Total Accessible</span><span class="text-green font-bold" style="font-size: 18px;">${formatCurrency(year15?.liquidAssets)}</span></div>
        <div style="font-size: 11px; color: #64748b; margin-top: 8px;">*Mega Backdoor + Backdoor IRA contributions only (not gains)</div>
      </div>
      <div class="info-box amber">
        <h3 class="text-amber">üîí Locked Until 59¬Ω</h3>
        <div class="row"><span>Pre-Tax 401k</span><span class="text-amber font-bold">${formatCurrency(year15?.retirement)}</span></div>
        <div class="row"><span>HSA (medical only)</span><span class="text-amber font-bold">${formatCurrency(year15?.hsa)}</span></div>
        <div class="row"><span>Roth Gains</span><span class="text-amber font-bold">${formatCurrency(rothGains)}</span></div>
        <div class="row total"><span class="font-bold">Total Locked</span><span class="text-amber font-bold" style="font-size: 18px;">${formatCurrency(year15?.retirementLocked)}</span></div>
        <div style="font-size: 11px; color: #64748b; margin-top: 8px;">10% penalty + taxes if withdrawn early</div>
      </div>
    `;

    document.getElementById('megaBackdoorInsight').innerHTML = `
      By year 15, <span class="text-pink font-bold">${formatCurrency(year15?.megaBackdoorContributions)}</span> of your Mega Backdoor Roth is accessible contribution money, while the gains (<span class="text-green">${formatCurrency(year15?.megaBackdoorGains)}</span>) grow tax-free for retirement.
    `;

    // Liquidity table
    let liqTableHTML = `
      <thead>
        <tr>
          <th>Year</th>
          <th>Age</th>
          <th class="text-green">Emergency</th>
          <th class="text-blue">Taxable</th>
          <th class="text-pink">Roth Contribs</th>
          <th class="text-green font-bold">Accessible</th>
          <th class="text-slate">% of NW</th>
        </tr>
      </thead>
      <tbody>
    `;
    projection.filter((_, i) => i % 2 === 0 || i === projection.length - 1).forEach(p => {
      liqTableHTML += `
        <tr>
          <td class="font-bold">${p.year}</td>
          <td>${p.age}</td>
          <td class="text-green">${formatShort(p.emergencyFund)}</td>
          <td class="text-blue">${formatShort(p.taxableBrokerage)}</td>
          <td class="text-pink">${formatShort(p.accessibleRothContributions)}</td>
          <td class="text-green font-bold">${formatShort(p.liquidAssets)}</td>
          <td class="text-slate">${Math.round((p.liquidAssets / p.netWorth) * 100)}%</td>
        </tr>
      `;
    });
      liqTableHTML += '</tbody>';
      document.getElementById('liquidityTable').innerHTML = liqTableHTML;
    }

    function renderSummary() {
      // Summary result
      document.getElementById('summaryResult').innerHTML = `
        <span class="text-pink font-bold">Result:</span> By age 57, you'll have
        <span class="text-green font-bold"> ~${formatCurrency(year15?.netWorth)}</span> net worth, with
        <span class="text-pink font-bold"> ~${formatCurrency(year15?.totalRoth)}</span> in tax-free Roth accounts and
        <span class="text-green font-bold"> ~${formatCurrency(year15?.liquidAssets)}</span> accessible without penalty.
      `;
    }

    // Tab switching
    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }
    window.showTab = showTab;

    // ============ INITIAL RENDER ============
    renderMetrics();
    createChart();
    renderProjectionTable();
    renderBrokerageNote();
    renderMilestones();
    renderLiquidity();
    renderSummary();
  </script>
</body>
</html>
